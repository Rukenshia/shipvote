{
	"variables": {
		"aws_access_key": "",
		"aws_secret_key": ""
	},
	"builders": [{
		"type": "amazon-ebs",
		"access_key": "{{user `aws_access_key`}}",
		"secret_key": "{{user `aws_secret_key`}}",
		"region": "eu-central-1",
		"force_deregister": "true",
		"force_delete_snapshot": "true",
		"source_ami": "ami-0ebe657bc328d4e82",
		"instance_type": "c5.4xlarge",
		"spot_price": "auto",
		"spot_price_auto_product": "Linux/UNIX",
		"ssh_username": "ec2-user",
		"ssh_interface": "public_ip",
		"ami_name": "shipvote",
		"tags": {
			"app": "shipvote",
			"tier": "web"
		}
	}],
	"provisioners": [
		{
			"type": "file",
			"source": "shipvote.service",
			"destination": "/tmp/shipvote.service"
		},
		{
			"type": "file",
			"source": "../backend",
			"destination": "/tmp/shipvote_src"
		},
		{
			"type": "file",
			"source": "shipvote.env",
			"destination": "/tmp/shipvote.env"
		},
		{
			"type": "file",
			"source": "limits.conf",
			"destination": "/tmp/limits.conf"
		},
		{
			"type": "shell",
			"inline": [
				"sudo yum group install -y 'Development Tools'",
				"sudo yum install -y ncurses-devel openssl-devel perl-core zlib-devel"
			]
		},
		{
			"type": "shell",
			"inline": [
				"curl -sL https://rpm.nodesource.com/setup_13.x | sudo -E bash -",
				"sudo yum install -y nodejs",
				"wget 'http://erlang.org/download/otp_src_22.2.tar.gz' -O otp.tar.gz",
				"tar xfz otp.tar.gz",
				"cd otp_src_22.2/",
				"./configure --prefix /usr",
				"make && sudo make install",
				"cd ..",
				"wget https://github.com/elixir-lang/elixir/archive/v1.10.1.tar.gz",
				"tar xfz v1.10.1.tar.gz",
				"cd elixir-1.10.1/",
				"export PATH=\"${PATH}:/usr/bin\"",
				"make && sudo make install"
			]
		},
		{
			"type": "shell",
			"inline": [
				"cd /tmp/shipvote_src",
				"export MIX_ENV=prod",
				"mix local.hex --force",
				"mix local.rebar --force",
				"mix deps.get",
				"cd assets && npm ci --no-progress && npm run deploy && cd ..",
				"mix phx.digest",
				"mix distillery.release --env=prod",
				"mv _build/prod/rel/backend/releases/*/backend.tar.gz /tmp/backend.tar.gz"
			]
		},
		{
			"type": "shell",
			"inline": [
				"sudo mv /tmp/shipvote.service /etc/systemd/system/shipvote.service",
				"sudo mkdir -p /opt/shipvote",
				"sudo chown -R ec2-user /opt/shipvote",
				"mv /tmp/shipvote.env /opt/shipvote",
				"tar -C /opt/shipvote -xzf /tmp/backend.tar.gz",
				"sudo systemctl daemon-reload",
				"sudo systemctl enable shipvote.service"
			]
		},
		{
			"type": "shell",
			"inline": [
				"sudo mv /tmp/limits.conf /etc/security/limits.conf",
				"ulimit -n"
			]
		}
	],
	"post-processors": [
		{
			"type": "manifest",
			"output": "manifest.json",
			"strip_path": true
		}
	]
}
